《光遇》.mesh 批量转 OBF 工具

简介

这是一个专为《光遇》（Sky: Children of the Light）游戏资源提取设计的 Python 脚本，用于将游戏中的 .mesh 模型文件批量转换为通用的 OBJ 格式。该脚本基于社区逆向工程成果，采用启发式解析方法，能自动尝试多种偏移组合，兼容大部分常规 .mesh 文件。支持交互式多选文件、自定义输出目录，可在手机（Termux）或电脑上运行。

功能特点

· 启发式解析：自动尝试多组偏移量，适应不同版本或编译参数的 .mesh 文件。
· 批量转换：支持一次性处理多个文件，命令行模式或交互式选择均可。
· 多选交互：交互模式下可通过序号、范围（如 1-5）、逗号/空格分隔或 all 快速选择文件。
· 自定义输出目录：可指定保存 OBJ 文件的文件夹，默认为当前目录。
· 详细调试信息：开启 DEBUG 后可输出解析过程，便于排查问题。
· 跨平台：基于 Python 3，依赖 LZ4 库，可在 Linux（包括 Termux）、Windows、macOS 上运行（Windows 需调整 LZ4 库路径）。

优点

1. 高成功率：对于不带特殊编译标志的常规 .mesh 文件，成功率高（实测 4690 个文件转换成功）。
2. 无需 Blender：直接在命令行完成转换，适合批量处理或集成到自动化流程。
3. 轻量便携：仅依赖 Python 和 LZ4，无需安装大型软件。
4. 用户友好：提供清晰的交互提示，支持文件多选和输出目录自定义。
5. 可定制：源码开放，可根据需要调整偏移量试探范围或增加新的解析分支。

缺点 / 局限性

1. 特殊标志文件失败：对于文件名或内部包含 ZipPos、ZipUvs、StripNorm、StripAnim、CompOcc 等特殊编译标志的模型，解析会失败（此类文件约占 20%）。这是因为这些文件的数据布局被深度优化，需要专门的逆向处理。
2. 仅支持 OBJ 格式：输出格式固定为 OBJ，不支持其他格式（如 FBX、GLTF）。
3. 依赖 LZ4 库：需手动安装 LZ4 动态库，Windows 用户需额外配置 DLL 路径。
4. 无纹理导出：仅导出几何模型（顶点、UV、面），不包含材质和纹理映射信息。

使用方法

环境准备

1. 安装 Python 3（建议 3.6 以上）。
2. 安装 LZ4 库：
   · Termux (Android)：pkg install lz4
   · Linux：sudo apt install liblz4-dev（或使用包管理器安装）
   · Windows：下载预编译的 LZ4 DLL（如从 lz4-win64 获取 msys-lz4-1.dll），并放在脚本同一目录或系统路径中。然后修改脚本中的 LZ4_LIB 变量为 DLL 的绝对路径（例如 'C:/path/to/msys-lz4-1.dll'）。
3. 保存脚本：将代码保存为 .py 文件，例如 sky_mesh_to_obj.py。

命令行模式

```bash
python sky_mesh_to_obj.py 文件1.mesh 文件2.mesh -o 输出目录
```

· 支持通配符（如 *.mesh）。
· 若不指定 -o，则输出到当前目录。

交互式模式

直接运行脚本（不带参数）：

```bash
python sky_mesh_to_obj.py
```

程序会列出当前目录下所有 .mesh 文件，并提示输入序号选择。支持：

· 单个序号：1
· 多个序号（空格/逗号分隔）：1 3 5 或 1,3,5
· 范围：1-5
· 全部：all
· 退出：q

选择文件后，会询问输出目录（直接回车使用当前目录），然后开始批量转换。

注意事项

· 文件命名：脚本会根据 .mesh 文件同名生成 .obj 文件（例如 model.mesh → model.obj）。
· 特殊标志文件：若解析失败，脚本会提示“文件可能为特殊格式”，并继续处理下一个文件。您可忽略这些文件，或尝试其他工具（如 Blender + Ogre 插件）。
· 调试信息：默认开启 DEBUG=True，可在解析失败时查看详细日志。如需静默运行，可将 DEBUG 设为 False。
· 内存使用：大文件解压可能占用较多内存，但通常不会超过 200MB。

可能的问题与解决方案

问题 可能原因 解决方法
无法加载 LZ4 库 LZ4 未安装或路径错误 安装 LZ4 库，或修改 LZ4_LIB 为正确的 DLL 路径（Windows）。
所有文件均解析失败 脚本偏移假设与当前游戏版本不匹配 尝试更新 candidate_sets 中的偏移值，或寻求社区帮助。
部分文件失败（文件名含特殊标志） 文件采用了压缩/优化选项 这是正常现象，可忽略或用专业工具处理。
导出的 OBJ 模型无纹理 脚本仅导出几何数据 需手动将 .ktx 纹理（可用 PVRTextTool 转换）赋予模型。

技术原理简述

1. LZ4 解压：读取文件头中的压缩大小和解压大小，定位压缩数据块，调用 LZ4 解压。
2. 偏移试探：尝试多组偏移量读取 compressed_size、uncompressed_size、num_lods，通过合理性检查筛选有效数据。
3. 顶点/UV/索引解析：从解压后的数据中，在预设偏移（如 0x74、0xb3）读取顶点数、UV 数，并按固定格式解析顶点（<fff4x）、UV（<4xee8x）、索引（<HHH）。
4. 验证：检查顶点数、面数、索引范围，确保数据正确。
5. OBJ 导出：按标准格式写入顶点、UV 和面索引。

致谢

本脚本基于论坛用户 longbyte1、DancingTwix 等的研究成果，以及社区逆向工程智慧。感谢所有为《光遇》资源提取做出贡献的开发者。

---

最后更新：2026年2月24日
版本：1.0
