《光遇》.mesh 批量转 OBJ 工具

简介

这是一个专为《光遇》（Sky: Children of the Light）游戏资源提取设计的 Python 脚本，用于将游戏中的 .mesh 模型文件批量转换为通用的 OBJ 格式。该脚本基于社区逆向工程成果，采用启发式解析处理常规模型，并针对启用了顶点压缩（compressPositions）和 UV 压缩（compressUvs）的特殊模型提供了专用解析器。同时，它能自动读取 MeshDefs.lua 中的编译参数，根据文件名关键词或解析失败自动切换解析方式，实现了对绝大多数 .mesh 文件的高兼容性。支持交互式多选文件、自定义输出目录，可在手机（Termux）或电脑上运行。

功能特点

· 双重解析引擎：
  · 启发式解析：自动尝试多组偏移量，兼容大部分不带压缩标志的常规 .mesh 文件。
  · 压缩模型解析：基于逆向工程，正确处理启用了 compressPositions / compressUvs 的模型（文件名常含 ZipPos、ZipUvs、StripNorm 等关键词）。
· 智能识别与后备：
  · 解析 MeshDefs.lua 获取每个模型的编译参数，自动选择解析器。
  · 文件名包含特殊关键词（如 StripAnim、CompOcc 等）时优先使用压缩解析器。
  · 启发式解析失败后自动尝试压缩解析器，最大限度提高成功率。
· 批量转换：支持一次性处理多个文件，命令行模式或交互式选择均可。
· 多选交互：交互模式下可通过序号、范围（如 1-5）、逗号/空格分隔或 all 快速选择文件。
· 自定义输出目录：可指定保存 OBJ 文件的文件夹，默认为当前目录。
· 详细调试信息：开启 DEBUG 后可输出解析过程，便于排查问题。
· 跨平台：基于 Python 3，依赖 LZ4 库，可在 Linux（包括 Termux）、Windows、macOS 上运行（Windows 需调整 LZ4 库路径）。

优点

1. 高成功率：实测 5906 个文件中成功转换 5905 个，剩余极少数文件可能因格式特殊或损坏无法解析。
2. 无需 Blender：直接在命令行完成转换，适合批量处理或集成到自动化流程。
3. 轻量便携：仅依赖 Python 和 LZ4，无需安装大型软件。
4. 用户友好：提供清晰的交互提示，支持文件多选和输出目录自定义。
5. 可定制：源码开放，可根据需要调整偏移量试探范围或增加新的解析分支。

缺点 / 局限性

1. 极少数文件可能失败：某些模型可能采用了更特殊的压缩方式（如 32 位索引强制）或数据布局与当前逆向结果不符，导致解析失败（目前失败率约 0.02%）。
2. 仅支持 OBJ 格式：输出格式固定为 OBJ，不支持其他格式（如 FBX、GLTF）。
3. 依赖 LZ4 库：需手动安装 LZ4 动态库，Windows 用户需额外配置 DLL 路径。
4. 无纹理导出：仅导出几何模型（顶点、UV、面），不包含材质和纹理映射信息（纹理需用 PVRTextTool 转换 .ktx 文件后手动赋予）。

使用方法

环境准备

1. 安装 Python 3（建议 3.6 以上）。
2. 安装 LZ4 库：
   · Termux (Android)：pkg install lz4
   · Linux：sudo apt install liblz4-dev（或使用包管理器安装）
   · Windows：下载预编译的 LZ4 DLL（如从 lz4-win64 获取 msys-lz4-1.dll），并放在脚本同一目录或系统路径中。然后修改脚本中的 LZ4_LIB 变量为 DLL 的绝对路径（例如 'C:/path/to/msys-lz4-1.dll'）。
3. 保存脚本：将代码保存为 .py 文件，例如 sky_mesh_to_obj.py。
4. （可选）放置 MeshDefs.lua：将游戏解包得到的 MeshDefs.lua 文件放在与脚本相同的目录下，以便自动识别压缩模型。如果没有此文件，脚本仍能运行，但部分压缩模型可能需依赖文件名关键词或后备机制才能正确解析。

命令行模式

```bash
python sky_mesh_to_obj.py 文件1.mesh 文件2.mesh -o 输出目录
```

· 支持通配符（如 *.mesh）。
· 若不指定 -o，则输出到当前目录。

交互式模式

直接运行脚本（不带参数）：

```bash
python sky_mesh_to_obj.py
```

程序会列出当前目录下所有 .mesh 文件，并提示输入序号选择。支持：

· 单个序号：1
· 多个序号（空格/逗号分隔）：1 3 5 或 1,3,5
· 范围：1-5
· 全部：all
· 退出：q

选择文件后，会询问输出目录（直接回车使用当前目录），然后开始批量转换。

注意事项

· 文件命名：脚本会根据 .mesh 文件同名生成 .obj 文件（例如 model.mesh → model.obj）。
· MeshDefs.lua：强烈建议将游戏解包得到的 MeshDefs.lua 放在脚本目录下，这能显著提高压缩模型的识别准确率。脚本会自动读取该文件。
· 特殊标志文件：即使没有 MeshDefs.lua，脚本也能通过文件名关键词（如 ZipPos）和后备机制处理大多数压缩模型。极少数无法解析的文件会提示失败。
· 调试信息：默认开启 DEBUG=True，可在解析失败时查看详细日志。如需静默运行，可将 DEBUG 设为 False。
· 内存使用：大文件解压可能占用较多内存，但通常不会超过 200MB。

技术原理简述

1. LZ4 解压：读取文件头中的压缩大小和解压大小，定位压缩数据块，调用 LZ4 解压。
2. 启发式解析：尝试多组偏移量读取 compressed_size、uncompressed_size、num_lods，通过合理性检查筛选有效数据，然后从解压后的数据中按常规格式解析顶点、UV 和索引。
3. 压缩模型解析：
   · 从固定偏移（0x60~0x74）读取量化参数（min 和 range）。
   · 从 0x74 和 0x78 读取顶点数（shared）和总顶点数（total）。
   · 顶点数据从 0x7c 开始，每个顶点用 6 字节（三个 16 位整数），结合量化参数还原为浮点数。
   · UV 数据紧跟在顶点之后，每个 UV 用 4 字节（两个 16 位整数），直接归一化到 [0,1]。
   · 自动搜索索引区域（16 位或 32 位），确保索引值小于顶点数。
4. 智能识别：读取 MeshDefs.lua 获得每个模型的编译参数，或根据文件名关键词判断是否为压缩模型。解析失败时自动尝试另一种解析器。
5. OBJ 导出：按标准格式写入顶点、UV 和面索引。

更新日志

v2.0 (2026-02-24)

· 增加压缩模型解析器，支持 compressPositions / compressUvs 标志的文件。
· 自动读取 MeshDefs.lua 文件，根据编译参数选择解析器。
· 文件名关键词检测（如 StripAnim、ZipPos 等）作为辅助判断。
· 启发式解析失败后自动尝试压缩解析器，提高容错率。
· 优化索引区域搜索算法，适应不同文件的索引起始偏移。
· 详细调试输出，便于问题排查。

致谢

本脚本基于论坛用户 longbyte1、DancingTwix、ether0x1 等的研究成果，以及社区逆向工程智慧。感谢所有为《光遇》资源提取做出贡献的开发者。

---

最后更新：2026年2月24日
版本：2.0
